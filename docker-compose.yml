name: proxy-dev

services:

  postgres:
    container_name: ${CONTAINER_NAME}-postgres
    build:
      context: ./docker/postgres
      args:
        - POSTGRES_VERSION=${POSTGRES_VERSION:-13}
    restart: always
    hostname: postgresql
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-proxydev}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-proxydev}
      POSTGRES_DB: ${POSTGRES_DB:-proxydev}
      TZ: ${CONTAINER_TIMEZONE:-America/Sao_Paulo}
      PGTZ: ${CONTAINER_TIMEZONE:-America/Sao_Paulo}
    volumes:
      - proxydev_postgresql:/var/lib/postgresql
      - proxydev_postgresql_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_DB_PORT:-5432}:5432"
    networks:
      - jp-networks

  mysql:
    container_name: ${CONTAINER_NAME}-mysql
    build:
      context: ./docker/mysql
      args:
        - MYSQL_VERSION=${MYSQL_VERSION:-8.0.32}
    restart: always
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-proxydev}
      MYSQL_USER: ${MYSQL_USER:-proxydev}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-proxydev}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      TZ: ${CONTAINER_TIMEZONE:-America/Sao_Paulo}
    volumes:
      - proxydev_mysql:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    ports:
      - "${MYSQL_DB_PORT:-3306}:3306"
    networks:
      - jp-networks

  redis:
    container_name: ${CONTAINER_NAME}-redis
    build:
      context: ./docker/redis
    restart: always
    volumes:
      - proxydev_redis:/data
      - ${REDIS_LOG_PATH:-./docker/logs/redis}:/var/log/redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-proxydev}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - jp-networks

  mailpit:
    container_name: ${CONTAINER_NAME}-mailpit
    build:
      context: ./docker/mailpit
    restart: always
    ports:
      - '${MAILTIP_PORT:-1025}:1025'
      - '${MAILTIP_PORT_DASHBOARD:-8025}:8025'
    networks:
      - jp-networks
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 8M

  caddy:
    container_name: ${CONTAINER_NAME}-caddy
    build:
      context: ./docker/caddy
    restart: always
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - proxydev_caddy_data:/data
    ports:
      - "${CADDY_PORT:-80}:80"
      - "${CADDY_TLS_PORT:-443}:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - jp-networks

networks:
  jp-networks:
    external: true

volumes:
  proxydev_mysql:
  proxydev_redis:
  proxydev_postgresql:
  proxydev_postgresql_data:
  proxydev_caddy_data:
